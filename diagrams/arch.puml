@startuml
skinparam componentStyle rectangle
skinparam shadowing false
skinparam wrapWidth 200

title PaperMC Ollama Plugin Architecture

actor Player

package "PaperMC Plugin" {

    component "Command Layer\n(AiCommand)" as Command
    component "Conversation Manager" as Convo
    component "Ollama Client\n(HttpOllamaClient)" as OllamaClient
    component "Tool Dispatcher" as Dispatcher
    component "Tool Handlers\n(give_item, server_status, ...)" as ToolHandlers
    component "Rate Limiter" as RateLimiter
    component "Config\n(YAML)" as Config
    database "Context Storage\n(SQLite / JSON)" as Storage
}

package "Ollama Server" {
    component "Model Runner\n(Ollama)" as Ollama
}

Player --> Command : /ai chat "message"

Command --> RateLimiter : check(player)
RateLimiter --> Command : allow/deny

Command --> Convo : appendPlayerMessage()
Command --> Convo : get conversation context

Command --> OllamaClient : async sendPrompt()
OllamaClient --> Ollama : POST /generate
Ollama --> OllamaClient : text + toolCalls
OllamaClient --> Command : async response

Command --> Convo : appendModelMessage()

Command --> Dispatcher : for each toolCall

Dispatcher --> ToolHandlers : validate + execute\n(main thread)
ToolHandlers --> Dispatcher : ToolResult

Dispatcher --> Convo : appendToolResult()
Dispatcher --> Command : tool result

Command --> Player : final in-game message

Convo --> Storage : persist context (optional)

@enduml
